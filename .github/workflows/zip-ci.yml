name: Gradle Plugin CI (Reusable)

on:
  workflow_call:
    inputs:
       artifact-retention-days:
        description: "Number of days to retain build artifacts"
        type: number
        default: 7
       artifact_id:
        description: "Project identifier"
        type: string
        default: "ttt-maps"
       files_prefix:
        description: "Project identifier"
        type: string
        default: "ttt_"

    secrets:
       MODTALE_API_KEY:
        description: "Modtale API key for authentication"
        required: false
       MODTALE_PROJECT_ID:
        description: "Modtale project ID"
        required: false
       CURSEFORGE_TOKEN:
        description: "CurseForge API token for authentication"
        required: false
       CURSEFORGE_PROJECT_ID:
        description: "CurseForge project ID (numerical)"
        required: false
    outputs:
      version:
        description: "The resolved version"
        value: ${{ jobs.build.outputs.version }}
      is_release:
        description: "Whether this is a release build"
        value: ${{ jobs.build.outputs.is_release }}
      hytale_server_version:
        description: "The Hytale Server version used for building"
        value: ${{ jobs.build.outputs.hytale_server_version }}

jobs:
  build:
    if: ${{ github.repository != 'nitrado/hytale-plugin-workflows' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      is_release: ${{ steps.version.outputs.is_release }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      hytale_server_version: ${{ steps.hytale-version.outputs.hytale_server_version }}
      zip_file_name: ${{ steps.compress.outputs.zip_file_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          # Semver regex with required leading v
          SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'
          
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            if [[ "$TAG_NAME" =~ $SEMVER_REGEX ]]; then
              # Strip leading 'v' for maven/jar version
              VERSION="${TAG_NAME#v}"
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
              echo "is_release=true" >> $GITHUB_OUTPUT
              # Check for prerelease suffix (e.g., -rc1, -alpha1, -beta2)
              if [[ "$VERSION" == *-* ]]; then
                echo "is_prerelease=true" >> $GITHUB_OUTPUT
                echo "Detected semver prerelease tag: $TAG_NAME (version: $VERSION)"
              else
                echo "is_prerelease=false" >> $GITHUB_OUTPUT
                echo "Detected semver release tag: $TAG_NAME (version: $VERSION)"
              fi
            else
              echo "Tag '$TAG_NAME' does not match required format (vX.Y.Z), using snapshot version"
              COMMIT_HASH=$(git rev-parse --short HEAD)
              echo "version=0.0.0-${COMMIT_HASH}" >> $GITHUB_OUTPUT
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          else
            COMMIT_HASH=$(git rev-parse --short HEAD)
            echo "version=0.0.0-${COMMIT_HASH}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "No tag detected, using snapshot version"
          fi

      - name: Fetch latest Hytale Server version
        id: hytale-version
        run: |
          echo "Fetching latest Hytale Server version from maven.hytale.com..."
          METADATA_URL="https://maven.hytale.com/release/com/hypixel/hytale/Server/maven-metadata.xml"
          
          METADATA=$(curl -sf "$METADATA_URL") || {
            echo "ERROR: Failed to fetch maven-metadata.xml from $METADATA_URL"
            exit 1
          }
          
          # Extract the latest version from <release> tag
          SERVER_VERSION=$(echo "$METADATA" | grep -oP '(?<=<release>)[^<]+' | head -1)
          
          if [[ -z "$SERVER_VERSION" ]]; then
            echo "ERROR: Could not parse Hytale Server version from maven-metadata.xml"
            echo "Metadata content:"
            echo "$METADATA"
            exit 1
          fi
          
          echo "hytale_server_version=$SERVER_VERSION" >> $GITHUB_OUTPUT
          echo "Detected Hytale Server version: $SERVER_VERSION"

      - name: Build Artifacts
        id: compress
        run: |
          ZIP_FILE_NAME="${{inputs.artifact_id}}.zip" 
          zip "$ZIP_FILE_NAME" ${{inputs.files_prefix}}*
          echo "zip_file_name=$ZIP_FILE_NAME" >> $GITHUB_OUTPUT
          echo "Generated zip file: $ZIP_FILE_NAME"

      - name: Upload Build Artifacts
        if: ${{ success() }}
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            ${{ steps.compress.outputs.zip_file_name }}
          retention-days: ${{ inputs.artifact-retention-days }}

  generate-changelog:
    needs: [build]
    if: ${{ needs.build.outputs.is_release == 'true' && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="${{ needs.build.outputs.tag_name }}"
          IS_PRERELEASE="${{ needs.build.outputs.is_prerelease }}"
          
          echo "Generating changelog for tag: $TAG_NAME (prerelease: $IS_PRERELEASE)"
          
          # Get all semver tags sorted descending by commit date (most recent first)
          # This ensures we get chronologically previous tags correctly
          SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'
          ALL_TAGS=$(git tag -l 'v*' --sort=-creatordate | while read tag; do
            if [[ "$tag" =~ $SEMVER_REGEX ]]; then
              echo "$tag"
            fi
          done)
          
          # Determine the comparison base tag
          FULL_RELEASE_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'
          PREV_TAG=""
          
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            # For prereleases: find previous release OR prerelease (any tag that came before)
            for tag in $ALL_TAGS; do
              if [[ "$tag" != "$TAG_NAME" ]]; then
                PREV_TAG="$tag"
                break
              fi
            done
            echo "Prerelease: comparing against previous tag: $PREV_TAG"
          else
            # For full releases: find previous full release only (no prerelease suffix)
            for tag in $ALL_TAGS; do
              if [[ "$tag" != "$TAG_NAME" && "$tag" =~ $FULL_RELEASE_REGEX ]]; then
                PREV_TAG="$tag"
                break
              fi
            done
            echo "Full release: comparing against previous full release: $PREV_TAG"
          fi
          
          PREV_VERSION="${PREV_TAG#v}"
          CURRENT_VERSION="${TAG_NAME#v}"
          
          # Extract base version (without prerelease suffix) for prerelease notice
          BASE_VERSION="${CURRENT_VERSION%%-*}"
          
          if [[ -z "$PREV_TAG" ]]; then
            echo "No previous tag found, using initial commit"
            HEADER="Changes since initial release:"
            CHANGELOG=$(gh api repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name="$TAG_NAME" \
              --jq '.body')
          else
            HEADER=$'# Automatically Generated Changelog\nBelow are the changes since `'"${PREV_VERSION}"$'`.'
            echo "Generating changelog from $PREV_TAG to $TAG_NAME"
            CHANGELOG=$(gh api repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name="$TAG_NAME" \
              -f previous_tag_name="$PREV_TAG" \
              --jq '.body')
          fi
          
          # Add prerelease notice if applicable
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            PRERELEASE_NOTICE=$'**This is a Pre-Release**\nThe changes below will be included in the next full release, version `'"${BASE_VERSION}"$'`.\n\n'
            HEADER="${PRERELEASE_NOTICE}${HEADER}"
          fi
          
          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="No changes recorded"
          fi
          
          # Combine header and changelog
          FULL_CHANGELOG="${HEADER}
          
          ${CHANGELOG}"
          
          # Output using EOF delimiter for multi-line support
          {
            echo 'changelog<<EOF'
            echo "$FULL_CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "Generated changelog:"
          echo "$FULL_CHANGELOG"

  publish:
    needs: [build, generate-changelog]
    if: ${{ needs.build.outputs.is_release == 'true' && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts

      - name: Generate release archive
        if: ${{ success() }}
        run: |
          ls -la
          mkdir dist
          mv ${{ needs.build.outputs.zip_file_name }} dist/${{ inputs.artifact_id }}-${{ needs.build.outputs.zip_file_name }}
          cd dist
          ls -la

      - name: Create GitHub Release
        if: ${{ success() }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag_name }}
          name: Release ${{ needs.build.outputs.version }}
          prerelease: ${{ needs.build.outputs.is_prerelease == 'true' }}
          body: ${{ needs.generate-changelog.outputs.changelog }}
          files: |
            dist/${{ inputs.artifact_id }}-${{ needs.build.outputs.zip_file_name }}

  publish-modtale:
    needs: [build, publish, generate-changelog]
    if: ${{ needs.build.outputs.is_release == 'true' && needs.publish.result == 'success' }}
    uses: kuttz-dev/hytale-plugin-workflows/.github/workflows/modtale-publish.yml@v1.1.0
    with:
      artifact-id: ${{ inputs.artifact_id }}
      game-versions: ${{ needs.build.outputs.hytale_server_version }}
      file-type: "zip"
    secrets:
      MODTALE_API_KEY: ${{ secrets.MODTALE_API_KEY }}
      MODTALE_PROJECT_ID: ${{ secrets.MODTALE_PROJECT_ID }}

  publish-curseforge:
    needs: [build, publish, generate-changelog]
    if: ${{ needs.build.outputs.is_release == 'true' && needs.publish.result == 'success' }}
    uses: kuttz-dev/hytale-plugin-workflows/.github/workflows/curseforge-publish.yml@v1.1.0
    with:
      artifact-id: ${{ inputs.artifact_id }}
      file-type: "zip"
    secrets:
      CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
      CURSEFORGE_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
